import{_ as A}from"./BGAeSPyx.js";import{e as R,a as I,n as L,u as U,b as B}from"./BIGBsnYa.js";import{s as N}from"./x_rD_Ya3.js";import{l as $,d as m,I as q,E as c,H as d,M as O,u as i,W as g,V as C,U as v,O as E,N as S,G as l,a0 as P}from"./Dp9Ai0YM.js";import{_ as H}from"./DlAUqK2U.js";import"./bq2zsT37.js";const J={class:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-50 flex items-center justify-center"},F={class:"max-w-md w-full mx-4"},G={key:0,class:"bg-white rounded-xl shadow-xl border border-gray-100 p-8 text-center"},W={class:"text-sm text-gray-500 space-y-1"},K={key:0},Q={key:1},X={key:2},Y={key:3},Z={key:4},ee={key:5},te={key:6},oe={key:7},se={key:8},ae={class:"mt-4 w-full bg-gray-200 rounded-full h-2"},re={class:"text-xs text-gray-400 mt-2"},ne={key:1,class:"bg-white rounded-xl shadow-xl border border-gray-100 p-8 text-center"},ie={class:"mb-6"},ce={class:"w-full bg-gray-200 rounded-full h-2"},le={class:"text-sm text-gray-500 mt-2"},de={key:2,class:"bg-white rounded-xl shadow-xl border border-gray-100 p-8 text-center"},ue={class:"text-gray-600 mb-6"},me={class:"space-y-3"},T=3e3,he=$({__name:"callback",setup(pe){const _=R(),f=m(!0),w=m(!1),k=m(!1),h=m(""),p=m(5),y=m(0),n=m("init"),b=m(0),u=s=>{const o=["init","parsing","tokens","verification","session","store","creating-shop","finalizing","redirect"],a=o.indexOf(s);b.value=Math.round(a/(o.length-1)*100)},j=()=>{const s=window.location.href,o=window.location.hash,a=window.location.search;console.log("🔍 [Callback] Analyse URL:",s);let t={access_token:"",refresh_token:"",token_hash:"",type:"",error:"",error_description:""};if(o&&o.length>1){const r=o.substring(1),e=new URLSearchParams(r);t.access_token=e.get("access_token")||"",t.refresh_token=e.get("refresh_token")||"",t.token_hash=e.get("token_hash")||"",t.type=e.get("type")||"",t.error=e.get("error")||"",t.error_description=e.get("error_description")||""}if(a){const r=new URLSearchParams(a);t.access_token||(t.access_token=r.get("access_token")||""),t.refresh_token||(t.refresh_token=r.get("refresh_token")||""),t.token_hash||(t.token_hash=r.get("token_hash")||""),t.type||(t.type=r.get("type")||""),t.error||(t.error=r.get("error")||""),t.error_description||(t.error_description=r.get("error_description")||"")}return t},D=async s=>{if(console.log("🔐 [Callback] Création session Supabase"),s.error)throw new Error(s.error_description||s.error);let o=null;if(s.token_hash){console.log("🔑 [Callback] Utilisation token_hash");const{data:a,error:t}=await _.auth.verifyOtp({token_hash:s.token_hash,type:s.type||"email"});if(t)throw new Error(`Erreur vérification: ${t.message}`);o=a}else if(s.access_token&&s.refresh_token){const{data:a,error:t}=await _.auth.setSession({access_token:s.access_token,refresh_token:s.refresh_token});if(t)throw new Error(`Erreur session: ${t.message}`);o=a}else throw new Error("Aucun token valide trouvé");return o},M=async(s,o)=>{console.log("🏪 [Callback] Vérification/création shop");const a=B();try{const e=await a.shops.get(s.id);if(e.success&&e.data)return console.log("✅ [Callback] Shop existant trouvé"),e.data}catch{console.log("ℹ️ [Callback] Shop non trouvé, création...")}const t={id:s.id,name:s.user_metadata?.company||`Shop de ${s.user_metadata?.first_name||s.email?.split("@")[0]}`,email:s.email,subscription_plan:"free",is_active:!0,onboarding_completed:!1,widget_config:{theme:"modern",primaryColor:"#E91E63",position:"bottom-right",buttonText:"Parler au vendeur",language:"fr"},agent_config:{name:"Rose",avatar:"https://ui-avatars.com/api/?name=Rose&background=E91E63&color=fff",welcomeMessage:"Bonjour ! Je suis votre assistante d'achat. Comment puis-je vous aider ?",fallbackMessage:"Je transmets votre question à notre équipe, un conseiller vous recontactera bientôt.",collectPaymentMethod:!0,upsellEnabled:!1}},r=await a.shops.create(t);if(!r.success)throw new Error(r.error||"Erreur création shop");return console.log("✅ [Callback] Shop créé avec succès"),r.data};q(async()=>{const s=Date.now();try{console.log("🔗 [Callback] Début traitement confirmation email"),n.value="parsing",u("parsing"),await new Promise(e=>setTimeout(e,800));const o=j();n.value="tokens",u("tokens"),await new Promise(e=>setTimeout(e,600)),n.value="verification",u("verification");const a=await D(o);if(!a?.user)throw new Error("Données utilisateur manquantes");console.log("✅ [Callback] Email confirmé pour:",a.user.email),n.value="session",u("session"),await new Promise(e=>setTimeout(e,600)),n.value="store",u("store");try{const e=I(),z=await e.fetchCompleteUserDataViaAPI(a.user,a.session.access_token);e.setUser(z,a.session.access_token),console.log("✅ [Callback] Store synchronisé")}catch(e){console.warn("⚠️ [Callback] Erreur store (non critique):",e)}await new Promise(e=>setTimeout(e,600)),n.value="creating-shop",u("creating-shop");try{const e=await M(a.user,a.session.access_token);console.log("✅ [Callback] Shop configuré")}catch(e){throw console.error("❌ [Callback] Erreur shop:",e),new Error(`Configuration espace échouée: ${e.message}`)}await new Promise(e=>setTimeout(e,800)),n.value="finalizing",u("finalizing"),await new Promise(e=>setTimeout(e,800)),n.value="redirect",u("redirect");const t=Date.now()-s,r=Math.max(0,T-t);r>0&&(console.log(`⏳ [Callback] Attente ${r}ms pour affichage minimum`),await new Promise(e=>setTimeout(e,r))),window.history.replaceState({},"",window.location.pathname),f.value=!1,w.value=!0,console.log("✅ [Callback] Confirmation terminée avec succès"),V()}catch(o){console.error("❌ [Callback] Erreur:",o);const a=Date.now()-s,t=Math.max(0,T-a);t>0&&await new Promise(r=>setTimeout(r,t)),f.value=!1,k.value=!0,o.message?.includes("expired")?h.value="Le lien de confirmation a expiré. Créez un nouveau compte.":o.message?.includes("invalid")||o.message?.includes("token")?h.value="Lien de confirmation invalide. Vérifiez votre email.":o.message?.includes("shop")||o.message?.includes("espace")?h.value="Email confirmé mais configuration échouée. Contactez le support.":h.value="Erreur de confirmation. Contactez le support si cela persiste."}});const V=()=>{const s=N(()=>{p.value--,y.value=(5-p.value)/5*100,p.value<=0&&(clearInterval(s),x())},1e3)},x=async()=>{console.log("🚀 [Callback] Redirection vers onboarding"),await L("/onboarding?from=email-confirmation&welcome=true")};return U({title:"Confirmation de compte - ChatSeller",meta:[{name:"description",content:"Confirmation de votre compte ChatSeller"},{name:"robots",content:"noindex"}]}),(s,o)=>{const a=A;return l(),c("div",J,[d("div",F,[i(f)?(l(),c("div",G,[o[0]||(o[0]=g('<div class="flex justify-center mb-4" data-v-d72b71b0><div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center" data-v-d72b71b0><svg class="animate-spin w-8 h-8 text-blue-600" fill="none" viewBox="0 0 24 24" data-v-d72b71b0><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" data-v-d72b71b0></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" data-v-d72b71b0></path></svg></div></div><h2 class="text-xl font-semibold text-gray-900 mb-2" data-v-d72b71b0> Confirmation en cours... </h2><p class="text-gray-600 mb-4" data-v-d72b71b0> Vérification de votre adresse email </p>',3)),d("div",W,[i(n)==="parsing"?(l(),c("p",K,"🔍 Analyse du lien de confirmation...")):i(n)==="tokens"?(l(),c("p",Q,"🔑 Récupération des informations...")):i(n)==="verification"?(l(),c("p",X,"✅ Vérification de votre email...")):i(n)==="session"?(l(),c("p",Y,"🔐 Création de votre session...")):i(n)==="store"?(l(),c("p",Z,"💾 Préparation de vos données...")):i(n)==="creating-shop"?(l(),c("p",ee,"🏪 Configuration de votre espace...")):i(n)==="finalizing"?(l(),c("p",te,"✨ Finalisation...")):i(n)==="redirect"?(l(),c("p",oe,"🚀 Préparation de votre onboarding...")):(l(),c("p",se,"⏳ Initialisation..."))]),d("div",ae,[d("div",{class:"bg-blue-600 h-2 rounded-full transition-all duration-500",style:C({width:`${i(b)}%`})},null,4)]),d("p",re,v(i(b))+"% terminé",1)])):i(w)?(l(),c("div",ne,[o[1]||(o[1]=g('<div class="flex justify-center mb-4" data-v-d72b71b0><div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center" data-v-d72b71b0><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-d72b71b0><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" data-v-d72b71b0></path></svg></div></div><h2 class="text-xl font-semibold text-gray-900 mb-2" data-v-d72b71b0> 🎉 Email confirmé avec succès ! </h2><p class="text-gray-600 mb-4" data-v-d72b71b0> Votre compte ChatSeller est maintenant activé </p><div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6" data-v-d72b71b0><p class="text-blue-800 text-sm" data-v-d72b71b0><strong data-v-d72b71b0>Prochaine étape :</strong> Configurons ensemble votre espace de vente IA </p></div>',4)),d("div",ie,[d("div",ce,[d("div",{class:"bg-gradient-to-r from-blue-600 to-green-600 h-2 rounded-full transition-all duration-100 ease-linear",style:C({width:`${i(y)}%`})},null,4)]),d("p",le," Configuration automatique dans "+v(i(p))+" secondes... ",1)]),d("button",{onClick:x,class:"w-full bg-gradient-to-r from-blue-600 to-green-600 text-white py-3 px-4 rounded-lg font-medium hover:from-blue-700 hover:to-green-700 transition-all shadow-lg transform hover:scale-105"}," Configurer mon espace maintenant ")])):i(k)?(l(),c("div",de,[o[4]||(o[4]=g('<div class="flex justify-center mb-4" data-v-d72b71b0><div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center" data-v-d72b71b0><svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-d72b71b0><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" data-v-d72b71b0></path></svg></div></div><h2 class="text-xl font-semibold text-gray-900 mb-2" data-v-d72b71b0> Erreur de confirmation </h2>',2)),d("p",ue,v(i(h)),1),d("div",me,[E(a,{to:"/register",class:"w-full inline-flex justify-center items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"},{default:S(()=>[...o[2]||(o[2]=[P(" Créer un nouveau compte ",-1)])]),_:1}),E(a,{to:"/login",class:"w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors"},{default:S(()=>[...o[3]||(o[3]=[P(" Se connecter ",-1)])]),_:1})])])):O("",!0)])])}}}),ke=H(he,[["__scopeId","data-v-d72b71b0"]]);export{ke as default};
