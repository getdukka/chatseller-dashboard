import{a as V,d as q}from"./BIGBsnYa.js";import{d as E,m as i,C as v}from"./Dp9Ai0YM.js";const G=()=>{const d=V(),c=q(),o=E([]),B=E(!1),l=E(!1),s=E(null),y=E(0),p=i(()=>{try{return d.planDetails||{name:"free",knowledgeBaseLimit:10,hasExpired:!1}}catch(e){return console.warn("⚠️ Erreur planDetails, utilisation fallback:",e),{name:"free",knowledgeBaseLimit:10,hasExpired:!1}}}),m=i(()=>o.value?.length||0),n=i(()=>{try{return p.value?.knowledgeBaseLimit||10}catch(e){return console.warn("⚠️ Erreur documentLimit, fallback:",e),10}}),h=i(()=>{try{return p.value?.hasExpired?!1:n.value===-1?!0:m.value<n.value}catch(e){return console.warn("⚠️ Erreur canUploadDocument, fallback false:",e),!1}}),A=i(()=>{try{return n.value===-1?-1:Math.max(0,n.value-m.value)}catch(e){return console.warn("⚠️ Erreur documentsRemaining, fallback 0:",e),0}}),$=i(()=>{try{return!h.value&&n.value!==-1}catch(e){return console.warn("⚠️ Erreur isLimitReached, fallback true:",e),!0}}),P=i(()=>{try{return o.value?.filter(e=>e?.isActive)||[]}catch(e){return console.warn("⚠️ Erreur activeDocuments:",e),[]}}),k=i(()=>{try{return o.value?.reduce((e,r)=>(e[r.contentType]||(e[r.contentType]=[]),e[r.contentType].push(r),e),{})||{}}catch(e){return console.warn("⚠️ Erreur documentsByType:",e),{}}}),L=i(()=>{try{return o.value?.reduce((e,r)=>e+(r?.metadata?.wordCount||0),0)||0}catch(e){return console.warn("⚠️ Erreur totalWordCount:",e),0}}),f=()=>{try{return d.token?{Authorization:`Bearer ${d.token}`,"Content-Type":"application/json"}:(console.warn("⚠️ [useKnowledgeBase] Pas de token disponible"),{"Content-Type":"application/json"})}catch(e){return console.error("❌ [useKnowledgeBase] Erreur getAuthHeaders:",e),{"Content-Type":"application/json"}}},w=(e,r)=>{console.error("❌ KB API Error:",e);let t=r;try{e?.data?.error&&typeof e.data.error=="string"?t=e.data.error:e?.response?.data?.error&&typeof e.response.data.error=="string"?t=e.response.data.error:e?.message&&typeof e.message=="string"?t=e.message:e?.statusText&&typeof e.statusText=="string"&&(t=`Erreur ${e.status||"API"}: ${e.statusText}`)}catch(a){console.warn("⚠️ Erreur parsing error message:",a)}return s.value=t,{success:!1,error:t}},b=e=>{try{if(p.value?.hasExpired)return s.value="❌ Votre essai gratuit de 7 jours est terminé. Passez au plan Starter pour ajouter des documents à votre base de connaissances.",!1;if(e==="create"&&!h.value){const r=n.value===-1?"illimitée":`${n.value} documents maximum`;return s.value=`❌ Limite de votre plan atteinte (${r}). Vous avez déjà ${m.value} documents. Passez au plan supérieur pour ajouter plus de documents.`,!1}return["update","delete","toggle"].includes(e)&&p.value?.hasExpired?(s.value="❌ Votre essai gratuit est terminé. Passez au plan Starter pour gérer vos documents.",!1):!0}catch(r){return console.error("❌ Erreur checkLimitsBeforeAction:",r),s.value="Erreur de vérification des limites",!1}},T=async()=>{B.value=!0,s.value=null;try{if(console.log("🔍 [useKnowledgeBase] Récupération des documents via API..."),!c?.public?.apiBaseUrl)throw new Error("Configuration API manquante");const e=await $fetch("/api/v1/knowledge-base",{baseURL:c.public.apiBaseUrl,headers:f(),timeout:1e4});if(e.success&&e.data){const r=e.data.filter(t=>t&&t.id);return o.value=r,console.log(`✅ [useKnowledgeBase] ${r.length} documents récupérés via API`),{success:!0,data:r}}else throw new Error(e.error||"Réponse API invalide")}catch(e){console.error("❌ [useKnowledgeBase] Erreur API:",e);const r=[];try{if(!p.value?.hasExpired){const t=[{id:"kb_demo_001",title:"Guide Produits (Mode Démo)",content:"Contenu de démonstration pour tester les fonctionnalités de base de connaissances.",contentType:"manual",tags:["demo","test","produits"],isActive:!0,shopId:d.userShopId||"demo-shop",linkedAgents:[],createdAt:new Date(Date.now()-1728e5).toISOString(),updatedAt:new Date().toISOString(),metadata:{wordCount:25,lastProcessed:new Date().toISOString()}}];n.value!==-1?r.push(...t.slice(0,n.value)):r.push(...t)}}catch(t){console.warn("⚠️ Erreur création fallback:",t)}return o.value=r,console.log(`⚠️ [useKnowledgeBase] Mode fallback: ${r.length} documents`),w(e,"Erreur lors de la récupération des documents")}finally{B.value=!1}},I=async e=>{l.value=!0,s.value=null;try{if(!e||!e.title||!e.content)throw new Error("Données de document invalides");if(!b("create"))return{success:!1,error:s.value||"Limite atteinte"};const r=await $fetch("/api/v1/knowledge-base",{method:"POST",baseURL:c.public.apiBaseUrl,headers:f(),timeout:15e3,body:{...e,shopId:d.userShopId||"demo-shop",isActive:e.isActive??!0,tags:e.tags||[]}});if(r.success&&r.data)return o.value.unshift(r.data),console.log(`✅ Document KB créé via API: ${r.data.id}`),{success:!0,data:r.data};throw new Error(r.error||"Réponse API invalide")}catch(r){return w(r,"Erreur lors de la création du document")}finally{l.value=!1}},S=async(e,r)=>{l.value=!0,s.value=null;try{if(console.log("📝 Modification du document KB via API:",e),!e||!r)throw new Error("ID ou données manquants");if(!b("update"))return{success:!1,error:s.value||"Accès limité"};const t=await $fetch(`/api/v1/knowledge-base/${e}`,{method:"PUT",baseURL:c.public.apiBaseUrl,headers:f(),timeout:15e3,body:r});if(t.success)if(t.data){const a=o.value.findIndex(u=>u?.id===e);return a!==-1&&(o.value[a]={...o.value[a],...t.data}),console.log(`✅ Document KB modifié via API: ${e}`),{success:!0,data:t.data}}else throw new Error("Données de réponse manquantes");else throw new Error(t.error||"Réponse API invalide")}catch(t){return w(t,"Erreur lors de la modification du document")}finally{l.value=!1}},x=async e=>{l.value=!0,s.value=null;try{if(console.log("🗑️ Suppression du document KB via API:",e),!e)throw new Error("ID document manquant");if(!b("delete"))return{success:!1,error:s.value||"Accès limité"};if((await $fetch(`/api/v1/knowledge-base/${e}`,{method:"DELETE",baseURL:c.public.apiBaseUrl,headers:f(),timeout:1e4}))?.success)return o.value=o.value.filter(t=>t?.id!==e),console.log(`✅ Document KB supprimé via API: ${e}`),console.log(`📊 Nouveau total: ${m.value}/${n.value===-1?"∞":n.value}`),{success:!0,data:null};throw new Error("Erreur lors de la suppression")}catch(r){return w(r,"Erreur lors de la suppression du document")}finally{l.value=!1}},U=async(e,r)=>{l.value=!0,s.value=null;try{if(console.log(`🔄 ${r?"Activation":"Désactivation"} du document KB via API:`,e),!e||typeof r!="boolean")throw new Error("Paramètres invalides");if(!b("toggle"))return{success:!1,error:s.value||"Accès limité"};const t=await $fetch(`/api/v1/knowledge-base/${e}/toggle`,{method:"PATCH",baseURL:c.public.apiBaseUrl,headers:f(),timeout:1e4,body:{isActive:r}});if(t?.success){const a=o.value.findIndex(u=>u?.id===e);return a!==-1&&(o.value[a].isActive=r,o.value[a].updatedAt=t.data?.updatedAt||new Date().toISOString()),console.log(`✅ Statut document KB modifié via API: ${e} -> ${r?"actif":"inactif"}`),{success:!0,data:null}}else throw new Error("Erreur lors de la modification du statut")}catch(t){return w(t,"Erreur lors de la modification du statut")}finally{l.value=!1}},C=e=>{try{if(!e?.trim())return o.value||[];const r=e.toLowerCase();return(o.value||[]).filter(t=>t?.title?.toLowerCase().includes(r)||t?.content?.toLowerCase().includes(r)||t?.tags?.some(a=>a?.toLowerCase().includes(r)))}catch(r){return console.warn("⚠️ Erreur searchDocuments:",r),[]}},R=e=>{try{return e?(o.value||[]).filter(r=>r?.isActive&&r?.linkedAgents?.includes(e)):[]}catch(r){return console.warn("⚠️ Erreur getDocumentsForAgent:",r),[]}},z=e=>{try{return e&&(o.value||[]).find(r=>r?.id===e)||null}catch(r){return console.warn("⚠️ Erreur getDocument:",r),null}},K=e=>{try{return{manual:"📝 Manuel",file:"📄 Fichier",url:"🔗 URL",website:"🌐 Site web"}[e]||e||"Inconnu"}catch(r){return console.warn("⚠️ Erreur getContentTypeLabel:",r),"Inconnu"}},M=e=>{try{if(!e||e===0)return"0 B";const r=1024,t=["B","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(r));return parseFloat((e/Math.pow(r,a)).toFixed(2))+" "+t[a]}catch(r){return console.warn("⚠️ Erreur formatFileSize:",r),"0 B"}},F=async e=>{l.value=!0,s.value=null,y.value=0;try{if(console.log("📤 Upload fichier KB:",e.name,e.type,e.size),!d.user)throw new Error("Utilisateur non connectifié");if(!h.value){const D=n.value===-1?"illimitée":`${n.value} documents maximum`;throw new Error(`Limite de votre plan atteinte (${D}). Vous avez déjà ${m.value} documents. Passez au plan supérieur pour ajouter plus de documents.`)}const t=p.value?.fileSizeLimit||5*1024*1024;if(e.size>t)throw new Error(`Fichier trop volumineux. Taille maximum : ${Math.round(t/1024/1024)}MB`);if(!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","text/csv"].includes(e.type))throw new Error("Type de fichier non supporté. Formats acceptés : PDF, DOC, DOCX, TXT, CSV");const u=new FormData;u.append("file",e),u.append("title",e.name),u.append("contentType","file"),u.append("tags",JSON.stringify(["fichier","upload"]));const g=await $fetch("/api/v1/knowledge-base/upload",{baseURL:c.public.apiBaseUrl,method:"POST",headers:{Authorization:`Bearer ${d.token}`},body:u,onUploadProgress:D=>{y.value=Math.round(D.loaded/D.total*100)}});if(g.success)return o.value.unshift(g.data),console.log(`✅ Fichier uploadé avec succès: ${g.data.id}`),{success:!0,data:g.data};throw new Error(g.error||"Erreur lors de l'upload")}catch(r){console.error("❌ Erreur upload fichier:",r);const t=r.response?.data?.error||r.message||"Erreur lors de l'upload du fichier";return s.value=t,{success:!1,error:t}}finally{l.value=!1,y.value=0}},j=async(e,r,t)=>{l.value=!0,s.value=null;try{if(console.log("🌐 Traitement site web:",e),!e||!e.startsWith("http"))throw new Error("URL invalide");if(!h.value){const u=n.value===-1?"illimitée":`${n.value} documents maximum`;throw new Error(`Limite de votre plan atteinte (${u}). Vous avez déjà ${m.value} documents. Passez au plan supérieur pour ajouter plus de documents.`)}const a=await $fetch("/api/v1/knowledge-base/website",{baseURL:c.public.apiBaseUrl,method:"POST",headers:f(),body:{url:e.trim(),title:r?.trim(),tags:t||["website","automatique"]}});if(a.success)return o.value.unshift(a.data),console.log(`✅ Site web traité avec succès: ${a.data.id}`),{success:!0,data:a.data};throw new Error(a.error||"Erreur lors du traitement du site web")}catch(a){console.error("❌ Erreur traitement site web:",a);const u=a.response?.data?.error||a.message||"Erreur lors du traitement du site web";return s.value=u,{success:!1,error:u}}finally{l.value=!1}},O=()=>{s.value=null};return{documents:v(o),loading:v(B),saving:v(l),error:v(s),uploadProgress:v(y),planDetails:v(p),currentDocumentCount:m,documentLimit:n,canUploadDocument:h,documentsRemaining:A,isLimitReached:$,activeDocuments:P,documentsByType:k,totalWordCount:L,fetchDocuments:T,createDocument:I,updateDocument:S,deleteDocument:x,toggleDocumentStatus:U,uploadFile:F,processWebsite:j,searchDocuments:C,getDocumentsForAgent:R,getDocument:z,getContentTypeLabel:K,formatFileSize:M,clearError:O}};export{G as u};
