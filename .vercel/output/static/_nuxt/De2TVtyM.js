import{i as A,a as b,e as f,k as a,n as i}from"./BIGBsnYa.js";import"./Dp9Ai0YM.js";import"./bq2zsT37.js";const S=A(async(o,n)=>{let s,t;console.log("üîí [AUTH] Middleware auth: V√©rification pour route:",o.path);const c=["/login","/register","/auth/callback","/auth/reset-password","/reset-password"],u=["/onboarding"],l=c.some(e=>o.path.startsWith(e)),d=u.some(e=>o.path.startsWith(e));if(o.path.startsWith("/auth/callback")){console.log("üîó [AUTH] Route callback - Passage libre total");return}if(l){console.log("‚úÖ [AUTH] Route publique, acc√®s libre:",o.path);return}console.log("üîê [AUTH] Route prot√©g√©e d√©tect√©e:",o.path);try{const e=b(),g=f(),{data:{user:r},error:h}=([s,t]=a(()=>g.auth.getUser()),s=await s,t(),s);if(h||!r)return console.log("‚ùå [AUTH] Pas de session Supabase valide"),e.clearAuth(),i("/login");if(console.log("‚úÖ [AUTH] Session Supabase valide pour:",r.email),!e.isAuthenticated||e.user?.id!==r.id){console.log("üîÑ [AUTH] Synchronisation store depuis session Supabase");try{[s,t]=a(()=>e.restoreSession()),await s,t(),console.log("‚úÖ [AUTH] Store synchronis√©")}catch(p){console.warn("‚ö†Ô∏è [AUTH] Erreur synchronisation store (non bloquante):",p)}}if(d){console.log("‚úÖ [AUTH] Route onboarding, acc√®s autoris√©");return}if(T(r,e.user))return console.log("üö® [AUTH] Redirection vers onboarding n√©cessaire"),i("/onboarding");console.log("‚úÖ [AUTH] Acc√®s autoris√© √†:",o.path)}catch(e){console.error("‚ùå [AUTH] Erreur critique:",e),console.log("‚ö†Ô∏è [AUTH] Erreur critique, autorisation d'acc√®s par d√©faut");return}});function T(o,n){return o.email_confirmed_at?Date.now()-new Date(o.created_at).getTime()<300*1e3&&!n?.shop?.name?(console.log("üö® [AUTH] Compte tr√®s r√©cent sans donn√©es"),!0):(console.log("‚úÖ [AUTH] Onboarding non requis - Acc√®s autoris√©"),!1):(console.log("üö® [AUTH] Email non confirm√©"),!0)}export{S as default};
